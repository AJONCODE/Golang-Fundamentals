package main

import (
	"fmt"
	"sync"
)

func main() {
	in := gen()

	// FAN OUT
	// Multiple functions reading from the same channel until that channel is closed
	// Distribute work across multiple functions (ten goroutines) that all read from in.
	c0 := factorial(in)
	c1 := factorial(in)
	c2 := factorial(in)
	c3 := factorial(in)
	c4 := factorial(in)
	c5 := factorial(in)
	c6 := factorial(in)
	c7 := factorial(in)
	c8 := factorial(in)
	c9 := factorial(in)

	// FAN IN
	// multiplex multiple channels onto a single channel
	// merge the channels from c0 through c9 onto a single channel
	var y int
	for n := range merge(c0, c1, c2, c3, c4, c5, c6, c7, c8, c9) {
		y++
		fmt.Println(y, ": \t", n)
	}
}

func gen() <-chan int {
	out := make(chan int)

	go func() {
		for i := 0; i < 100; i++ {
			for j := 3; j < 13; j++ {
				out <- j
			}
		}
		close(out)
	}()

	return out
}

func factorial(in <-chan int) <-chan int {
	out := make(chan int)

	go func() {
		for n := range in {
			out <- fact(n)
		}
		close(out)
	}()

	return out
}

func fact(n int) int {
	total := 1

	for i := n; i > 1; i-- {
		total *= i
	}

	return total
}

func merge(cs ...<-chan int) <-chan int {
	var wg sync.WaitGroup
	out := make(chan int)

	wg.Add(len(cs))

	output := func(ch <-chan int) {
		for n := range ch {
			out <- n
		}
		wg.Done()
	}

	for _, c := range cs {
		go output(c)
	}

	// Start a goroutine to close out once all the output goroutines are
	// done.  This must start after the wg.Add call.
	go func() {
		wg.Wait()
		close(out)
	}()

	return out
}

// go run -race main.go
// 1 :      6
// 2 :      24
// 3 :      120
// 4 :      720
// 5 :      5040
// 6 :      40320
// 7 :      362880
// 8 :      3628800
// 9 :      39916800
// 10 :     479001600
// 11 :     6
// 12 :     120
// 13 :     24
// 14 :     720
// 15 :     24
// 16 :     40320
// 17 :     362880
// 18 :     5040
// 19 :     3628800
// 20 :     479001600
// 21 :     6
// 22 :     39916800
// 23 :     120
// 24 :     720
// 25 :     5040
// 26 :     40320
// 27 :     479001600
// 28 :     362880
// 29 :     6
// 30 :     3628800
// 31 :     24
// 32 :     39916800
// 33 :     362880
// 34 :     39916800
// 35 :     720
// 36 :     40320
// 37 :     5040
// 38 :     120
// 39 :     5040
// 40 :     3628800
// 41 :     6
// 42 :     362880
// 43 :     120
// 44 :     39916800
// 45 :     3628800
// 46 :     479001600
// 47 :     24
// 48 :     720
// 49 :     720
// 50 :     24
// 51 :     40320
// 52 :     479001600
// 53 :     39916800
// 54 :     3628800
// 55 :     120
// 56 :     6
// 57 :     5040
// 58 :     479001600
// 59 :     362880
// 60 :     40320
// 61 :     5040
// 62 :     40320
// 63 :     6
// 64 :     3628800
// 65 :     39916800
// 66 :     5040
// 67 :     120
// 68 :     24
// 69 :     720
// 70 :     720
// 71 :     362880
// 72 :     479001600
// 73 :     40320
// 74 :     6
// 75 :     24
// 76 :     6
// 77 :     720
// 78 :     479001600
// 79 :     24
// 80 :     120
// 81 :     5040
// 82 :     120
// 83 :     6
// 84 :     362880
// 85 :     3628800
// 86 :     39916800
// 87 :     479001600
// 88 :     24
// 89 :     362880
// 90 :     6
// 91 :     3628800
// 92 :     39916800
// 93 :     40320
// 94 :     40320
// 95 :     362880
// 96 :     39916800
// 97 :     24
// 98 :     120
// 99 :     5040
// 100 :    720
// 101 :    3628800
// 102 :    479001600
// 103 :    40320
// 104 :    3628800
// 105 :    24
// 106 :    120
// 107 :    120
// 108 :    39916800
// 109 :    5040
// 110 :    479001600
// 111 :    720
// 112 :    362880
// 113 :    3628800
// 114 :    5040
// 115 :    362880
// 116 :    6
// 117 :    40320
// 118 :    720
// 119 :    40320
// 120 :    720
// 121 :    39916800
// 122 :    479001600
// 123 :    6
// 124 :    24
// 125 :    5040
// 126 :    720
// 127 :    120
// 128 :    39916800
// 129 :    479001600
// 130 :    24
// 131 :    120
// 132 :    3628800
// 133 :    6
// 134 :    362880
// 135 :    3628800
// 136 :    362880
// 137 :    40320
// 138 :    40320
// 139 :    5040
// 140 :    6
// 141 :    479001600
// 142 :    24
// 143 :    720
// 144 :    5040
// 145 :    5040
// 146 :    39916800
// 147 :    120
// 148 :    120
// 149 :    362880
// 150 :    39916800
// 151 :    720
// 152 :    720
// 153 :    479001600
// 154 :    6
// 155 :    3628800
// 156 :    24
// 157 :    479001600
// 158 :    39916800
// 159 :    3628800
// 160 :    120
// 161 :    39916800
// 162 :    40320
// 163 :    362880
// 164 :    6
// 165 :    24
// 166 :    3628800
// 167 :    5040
// 168 :    5040
// 169 :    40320
// 170 :    720
// 171 :    24
// 172 :    6
// 173 :    120
// 174 :    362880
// 175 :    120
// 176 :    40320
// 177 :    479001600
// 178 :    39916800
// 179 :    3628800
// 180 :    6
// 181 :    24
// 182 :    479001600
// 183 :    362880
// 184 :    720
// 185 :    40320
// 186 :    362880
// 187 :    362880
// 188 :    5040
// 189 :    479001600
// 190 :    24
// 191 :    120
// 192 :    39916800
// 193 :    3628800
// 194 :    40320
// 195 :    39916800
// 196 :    6
// 197 :    720
// 198 :    5040
// 199 :    24
// 200 :    5040
// 201 :    3628800
// 202 :    479001600
// 203 :    6
// 204 :    120
// 205 :    39916800
// 206 :    40320
// 207 :    479001600
// 208 :    3628800
// 209 :    720
// 210 :    3628800
// 211 :    362880
// 212 :    362880
// 213 :    24
// 214 :    120
// 215 :    5040
// 216 :    40320
// 217 :    6
// 218 :    720
// 219 :    720
// 220 :    120
// 221 :    24
// 222 :    6
// 223 :    24
// 224 :    479001600
// 225 :    39916800
// 226 :    5040
// 227 :    3628800
// 228 :    39916800
// 229 :    479001600
// 230 :    362880
// 231 :    40320
// 232 :    120
// 233 :    5040
// 234 :    3628800
// 235 :    362880
// 236 :    6
// 237 :    40320
// 238 :    720
// 239 :    479001600
// 240 :    24
// 241 :    720
// 242 :    39916800
// 243 :    6
// 244 :    120
// 245 :    6
// 246 :    40320
// 247 :    3628800
// 248 :    362880
// 249 :    39916800
// 250 :    24
// 251 :    5040
// 252 :    479001600
// 253 :    479001600
// 254 :    40320
// 255 :    3628800
// 256 :    362880
// 257 :    39916800
// 258 :    120
// 259 :    6
// 260 :    5040
// 261 :    720
// 262 :    24
// 263 :    362880
// 264 :    24
// 265 :    5040
// 266 :    120
// 267 :    720
// 268 :    40320
// 269 :    3628800
// 270 :    479001600
// 271 :    6
// 272 :    39916800
// 273 :    3628800
// 274 :    479001600
// 275 :    120
// 276 :    6
// 277 :    24
// 278 :    5040
// 279 :    40320
// 280 :    39916800
// 281 :    362880
// 282 :    362880
// 283 :    720
// 284 :    120
// 285 :    720
// 286 :    5040
// 287 :    3628800
// 288 :    40320
// 289 :    362880
// 290 :    39916800
// 291 :    479001600
// 292 :    5040
// 293 :    40320
// 294 :    3628800
// 295 :    6
// 296 :    24
// 297 :    24
// 298 :    720
// 299 :    120
// 300 :    120
// 301 :    39916800
// 302 :    39916800
// 303 :    479001600
// 304 :    5040
// 305 :    6
// 306 :    362880
// 307 :    40320
// 308 :    5040
// 309 :    720
// 310 :    3628800
// 311 :    479001600
// 312 :    24
// 313 :    5040
// 314 :    40320
// 315 :    362880
// 316 :    6
// 317 :    120
// 318 :    720
// 319 :    24
// 320 :    3628800
// 321 :    39916800
// 322 :    479001600
// 323 :    24
// 324 :    362880
// 325 :    40320
// 326 :    6
// 327 :    120
// 328 :    720
// 329 :    120
// 330 :    3628800
// 331 :    479001600
// 332 :    6
// 333 :    720
// 334 :    5040
// 335 :    40320
// 336 :    39916800
// 337 :    362880
// 338 :    3628800
// 339 :    120
// 340 :    479001600
// 341 :    720
// 342 :    6
// 343 :    24
// 344 :    39916800
// 345 :    40320
// 346 :    362880
// 347 :    39916800
// 348 :    120
// 349 :    479001600
// 350 :    6
// 351 :    24
// 352 :    720
// 353 :    3628800
// 354 :    5040
// 355 :    6
// 356 :    24
// 357 :    40320
// 358 :    362880
// 359 :    3628800
// 360 :    39916800
// 361 :    479001600
// 362 :    5040
// 363 :    6
// 364 :    5040
// 365 :    120
// 366 :    3628800
// 367 :    39916800
// 368 :    362880
// 369 :    24
// 370 :    720
// 371 :    24
// 372 :    120
// 373 :    40320
// 374 :    479001600
// 375 :    5040
// 376 :    362880
// 377 :    39916800
// 378 :    3628800
// 379 :    6
// 380 :    120
// 381 :    479001600
// 382 :    720
// 383 :    720
// 384 :    40320
// 385 :    5040
// 386 :    6
// 387 :    362880
// 388 :    40320
// 389 :    479001600
// 390 :    39916800
// 391 :    3628800
// 392 :    479001600
// 393 :    39916800
// 394 :    39916800
// 395 :    3628800
// 396 :    120
// 397 :    24
// 398 :    5040
// 399 :    720
// 400 :    40320
// 401 :    362880
// 402 :    120
// 403 :    24
// 404 :    40320
// 405 :    6
// 406 :    6
// 407 :    720
// 408 :    5040
// 409 :    362880
// 410 :    3628800
// 411 :    120
// 412 :    479001600
// 413 :    720
// 414 :    24
// 415 :    5040
// 416 :    24
// 417 :    39916800
// 418 :    40320
// 419 :    479001600
// 420 :    6
// 421 :    3628800
// 422 :    362880
// 423 :    6
// 424 :    120
// 425 :    5040
// 426 :    3628800
// 427 :    720
// 428 :    40320
// 429 :    39916800
// 430 :    362880
// 431 :    40320
// 432 :    6
// 433 :    479001600
// 434 :    720
// 435 :    362880
// 436 :    5040
// 437 :    3628800
// 438 :    24
// 439 :    120
// 440 :    720
// 441 :    24
// 442 :    5040
// 443 :    39916800
// 444 :    479001600
// 445 :    120
// 446 :    362880
// 447 :    3628800
// 448 :    39916800
// 449 :    6
// 450 :    24
// 451 :    479001600
// 452 :    40320
// 453 :    6
// 454 :    479001600
// 455 :    362880
// 456 :    39916800
// 457 :    24
// 458 :    720
// 459 :    5040
// 460 :    5040
// 461 :    40320
// 462 :    120
// 463 :    3628800
// 464 :    120
// 465 :    720
// 466 :    40320
// 467 :    3628800
// 468 :    479001600
// 469 :    39916800
// 470 :    120
// 471 :    24
// 472 :    720
// 473 :    362880
// 474 :    6
// 475 :    5040
// 476 :    40320
// 477 :    362880
// 478 :    3628800
// 479 :    6
// 480 :    39916800
// 481 :    120
// 482 :    24
// 483 :    479001600
// 484 :    720
// 485 :    5040
// 486 :    40320
// 487 :    3628800
// 488 :    39916800
// 489 :    362880
// 490 :    479001600
// 491 :    6
// 492 :    24
// 493 :    720
// 494 :    40320
// 495 :    120
// 496 :    5040
// 497 :    362880
// 498 :    3628800
// 499 :    6
// 500 :    479001600
// 501 :    39916800
// 502 :    24
// 503 :    5040
// 504 :    120
// 505 :    720
// 506 :    3628800
// 507 :    40320
// 508 :    362880
// 509 :    39916800
// 510 :    479001600
// 511 :    24
// 512 :    720
// 513 :    120
// 514 :    6
// 515 :    5040
// 516 :    40320
// 517 :    362880
// 518 :    6
// 519 :    3628800
// 520 :    479001600
// 521 :    24
// 522 :    39916800
// 523 :    120
// 524 :    5040
// 525 :    720
// 526 :    40320
// 527 :    362880
// 528 :    39916800
// 529 :    479001600
// 530 :    3628800
// 531 :    24
// 532 :    6
// 533 :    120
// 534 :    720
// 535 :    40320
// 536 :    5040
// 537 :    3628800
// 538 :    362880
// 539 :    6
// 540 :    479001600
// 541 :    24
// 542 :    39916800
// 543 :    720
// 544 :    120
// 545 :    362880
// 546 :    3628800
// 547 :    40320
// 548 :    5040
// 549 :    479001600
// 550 :    6
// 551 :    39916800
// 552 :    24
// 553 :    720
// 554 :    120
// 555 :    40320
// 556 :    362880
// 557 :    5040
// 558 :    39916800
// 559 :    3628800
// 560 :    24
// 561 :    720
// 562 :    6
// 563 :    479001600
// 564 :    40320
// 565 :    362880
// 566 :    5040
// 567 :    120
// 568 :    3628800
// 569 :    39916800
// 570 :    24
// 571 :    479001600
// 572 :    6
// 573 :    720
// 574 :    40320
// 575 :    5040
// 576 :    120
// 577 :    3628800
// 578 :    39916800
// 579 :    362880
// 580 :    24
// 581 :    479001600
// 582 :    120
// 583 :    6
// 584 :    720
// 585 :    362880
// 586 :    5040
// 587 :    3628800
// 588 :    40320
// 589 :    39916800
// 590 :    479001600
// 591 :    120
// 592 :    24
// 593 :    6
// 594 :    40320
// 595 :    720
// 596 :    3628800
// 597 :    5040
// 598 :    362880
// 599 :    479001600
// 600 :    39916800
// 601 :    6
// 602 :    120
// 603 :    720
// 604 :    5040
// 605 :    24
// 606 :    40320
// 607 :    362880
// 608 :    3628800
// 609 :    39916800
// 610 :    24
// 611 :    6
// 612 :    479001600
// 613 :    120
// 614 :    720
// 615 :    40320
// 616 :    5040
// 617 :    362880
// 618 :    3628800
// 619 :    6
// 620 :    479001600
// 621 :    39916800
// 622 :    24
// 623 :    720
// 624 :    120
// 625 :    40320
// 626 :    5040
// 627 :    39916800
// 628 :    3628800
// 629 :    362880
// 630 :    6
// 631 :    479001600
// 632 :    720
// 633 :    120
// 634 :    5040
// 635 :    24
// 636 :    40320
// 637 :    362880
// 638 :    3628800
// 639 :    39916800
// 640 :    24
// 641 :    479001600
// 642 :    120
// 643 :    6
// 644 :    720
// 645 :    5040
// 646 :    3628800
// 647 :    40320
// 648 :    39916800
// 649 :    362880
// 650 :    479001600
// 651 :    24
// 652 :    6
// 653 :    720
// 654 :    5040
// 655 :    120
// 656 :    362880
// 657 :    40320
// 658 :    3628800
// 659 :    479001600
// 660 :    39916800
// 661 :    6
// 662 :    720
// 663 :    24
// 664 :    5040
// 665 :    120
// 666 :    40320
// 667 :    362880
// 668 :    479001600
// 669 :    39916800
// 670 :    3628800
// 671 :    6
// 672 :    24
// 673 :    6
// 674 :    5040
// 675 :    120
// 676 :    40320
// 677 :    720
// 678 :    362880
// 679 :    3628800
// 680 :    39916800
// 681 :    479001600
// 682 :    24
// 683 :    120
// 684 :    3628800
// 685 :    362880
// 686 :    479001600
// 687 :    40320
// 688 :    40320
// 689 :    362880
// 690 :    720
// 691 :    5040
// 692 :    24
// 693 :    6
// 694 :    39916800
// 695 :    39916800
// 696 :    479001600
// 697 :    6
// 698 :    3628800
// 699 :    5040
// 700 :    24
// 701 :    120
// 702 :    120
// 703 :    5040
// 704 :    720
// 705 :    362880
// 706 :    3628800
// 707 :    720
// 708 :    40320
// 709 :    479001600
// 710 :    6
// 711 :    120
// 712 :    39916800
// 713 :    720
// 714 :    362880
// 715 :    24
// 716 :    5040
// 717 :    40320
// 718 :    479001600
// 719 :    3628800
// 720 :    39916800
// 721 :    6
// 722 :    120
// 723 :    24
// 724 :    5040
// 725 :    720
// 726 :    362880
// 727 :    40320
// 728 :    39916800
// 729 :    3628800
// 730 :    6
// 731 :    479001600
// 732 :    24
// 733 :    40320
// 734 :    5040
// 735 :    720
// 736 :    120
// 737 :    362880
// 738 :    39916800
// 739 :    3628800
// 740 :    24
// 741 :    479001600
// 742 :    6
// 743 :    120
// 744 :    720
// 745 :    362880
// 746 :    5040
// 747 :    40320
// 748 :    3628800
// 749 :    39916800
// 750 :    6
// 751 :    24
// 752 :    479001600
// 753 :    720
// 754 :    120
// 755 :    362880
// 756 :    5040
// 757 :    40320
// 758 :    3628800
// 759 :    39916800
// 760 :    6
// 761 :    479001600
// 762 :    120
// 763 :    720
// 764 :    24
// 765 :    5040
// 766 :    40320
// 767 :    39916800
// 768 :    3628800
// 769 :    479001600
// 770 :    362880
// 771 :    6
// 772 :    24
// 773 :    120
// 774 :    5040
// 775 :    720
// 776 :    362880
// 777 :    40320
// 778 :    3628800
// 779 :    39916800
// 780 :    24
// 781 :    6
// 782 :    120
// 783 :    720
// 784 :    479001600
// 785 :    362880
// 786 :    5040
// 787 :    40320
// 788 :    39916800
// 789 :    479001600
// 790 :    3628800
// 791 :    6
// 792 :    120
// 793 :    24
// 794 :    720
// 795 :    40320
// 796 :    5040
// 797 :    362880
// 798 :    3628800
// 799 :    39916800
// 800 :    479001600
// 801 :    120
// 802 :    6
// 803 :    24
// 804 :    362880
// 805 :    40320
// 806 :    5040
// 807 :    39916800
// 808 :    720
// 809 :    3628800
// 810 :    479001600
// 811 :    24
// 812 :    6
// 813 :    120
// 814 :    720
// 815 :    5040
// 816 :    40320
// 817 :    362880
// 818 :    479001600
// 819 :    39916800
// 820 :    24
// 821 :    3628800
// 822 :    120
// 823 :    720
// 824 :    6
// 825 :    5040
// 826 :    40320
// 827 :    362880
// 828 :    39916800
// 829 :    3628800
// 830 :    6
// 831 :    479001600
// 832 :    120
// 833 :    24
// 834 :    720
// 835 :    5040
// 836 :    40320
// 837 :    362880
// 838 :    3628800
// 839 :    39916800
// 840 :    479001600
// 841 :    6
// 842 :    120
// 843 :    24
// 844 :    5040
// 845 :    720
// 846 :    362880
// 847 :    40320
// 848 :    3628800
// 849 :    479001600
// 850 :    39916800
// 851 :    120
// 852 :    5040
// 853 :    6
// 854 :    24
// 855 :    720
// 856 :    40320
// 857 :    362880
// 858 :    3628800
// 859 :    24
// 860 :    39916800
// 861 :    6
// 862 :    720
// 863 :    120
// 864 :    5040
// 865 :    479001600
// 866 :    40320
// 867 :    3628800
// 868 :    362880
// 869 :    479001600
// 870 :    39916800
// 871 :    120
// 872 :    24
// 873 :    6
// 874 :    720
// 875 :    5040
// 876 :    40320
// 877 :    362880
// 878 :    39916800
// 879 :    3628800
// 880 :    24
// 881 :    6
// 882 :    479001600
// 883 :    120
// 884 :    720
// 885 :    5040
// 886 :    40320
// 887 :    3628800
// 888 :    39916800
// 889 :    362880
// 890 :    479001600
// 891 :    6
// 892 :    120
// 893 :    24
// 894 :    720
// 895 :    362880
// 896 :    5040
// 897 :    3628800
// 898 :    40320
// 899 :    479001600
// 900 :    39916800
// 901 :    24
// 902 :    6
// 903 :    120
// 904 :    40320
// 905 :    5040
// 906 :    720
// 907 :    3628800
// 908 :    362880
// 909 :    120
// 910 :    39916800
// 911 :    479001600
// 912 :    5040
// 913 :    6
// 914 :    24
// 915 :    720
// 916 :    40320
// 917 :    362880
// 918 :    6
// 919 :    479001600
// 920 :    39916800
// 921 :    5040
// 922 :    24
// 923 :    3628800
// 924 :    720
// 925 :    120
// 926 :    40320
// 927 :    39916800
// 928 :    362880
// 929 :    3628800
// 930 :    479001600
// 931 :    120
// 932 :    24
// 933 :    6
// 934 :    720
// 935 :    3628800
// 936 :    40320
// 937 :    362880
// 938 :    39916800
// 939 :    5040
// 940 :    479001600
// 941 :    6
// 942 :    720
// 943 :    120
// 944 :    24
// 945 :    5040
// 946 :    39916800
// 947 :    40320
// 948 :    3628800
// 949 :    362880
// 950 :    479001600
// 951 :    6
// 952 :    120
// 953 :    24
// 954 :    720
// 955 :    3628800
// 956 :    40320
// 957 :    39916800
// 958 :    5040
// 959 :    6
// 960 :    362880
// 961 :    24
// 962 :    479001600
// 963 :    120
// 964 :    5040
// 965 :    362880
// 966 :    40320
// 967 :    720
// 968 :    6
// 969 :    3628800
// 970 :    39916800
// 971 :    120
// 972 :    24
// 973 :    5040
// 974 :    479001600
// 975 :    720
// 976 :    3628800
// 977 :    40320
// 978 :    362880
// 979 :    39916800
// 980 :    479001600
// 981 :    6
// 982 :    24
// 983 :    5040
// 984 :    720
// 985 :    120
// 986 :    362880
// 987 :    40320
// 988 :    3628800
// 989 :    39916800
// 990 :    479001600
// 991 :    720
// 992 :    6
// 993 :    24
// 994 :    120
// 995 :    5040
// 996 :    40320
// 997 :    362880
// 998 :    3628800
// 999 :    479001600
// 1000 :   39916800
